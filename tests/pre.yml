# pre test file for cacti-server
---
- name: percona repo
  apt:
    deb: "https://repo.percona.com/apt/percona-release_latest.{{ ansible_lsb.codename }}_all.deb"

- name: add ondrej repo
  apt_repository:
    repo: ppa:ondrej/php
    update_cache: true

- name: install php
  apt:
    name:
      - libapache2-mod-php7.1
      - php7.1-cli
      - php7.1-gd
      - php7.1-gmp
      - php7.1-json
      - php7.1-ldap
      - php7.1-mbstring
      - php7.1-mysql
      - php7.1-opcache
      - php7.1-snmp
      - php7.1-xml
    state: "{{ apt_install_state | default('latest') }}"
    update_cache: true
    cache_valid_time: "{{ apt_update_cache_valid_time | default(3600) }}"

- name: install percona server
  debconf:
    name: "{{ item.name }}"
    question: "{{ item.question }}"
    value: "{{ item.value }}"
    vtype: "{{ item.vtype }}"
  with_items:
    - name: "percona-server-server-5.7"
      question: "percona-server-server-5.7/root-pass"
      value: "{{ cacti_server_percona_server_root_password }}"
      vtype: password
    - name: "percona-server-server-5.7"
      question: "percona-server-server-5.7/re-root-pass"
      value: "{{ cacti_server_percona_server_root_password }}"
      vtype: password
  changed_when: false

- name: install percona server
  apt:
    name:
      - percona-server-client-5.7
      - percona-server-server-5.7
      - libperconaserverclient20
      - python-mysqldb
    state: "{{ apt_install_state | default('latest') }}"

- name: install percona server
  copy:
    dest: '~root/.my.cnf'
    content: |
      [client]
      host = localhost
      port = 3306
      user = root
      password = '{{ cacti_server_percona_server_root_password }}'
    owner: root
    group: root
    mode: 0600

- name: zoneinfo
  shell: >
    mysql_tzinfo_to_sql /usr/share/zoneinfo | tee /tmp/zoneinfo.sql | mysql --database=mysql
  args:
    creates: /tmp/zoneinfo.sql

- name: ensure database
  mysql_db:
    name: "{{ cacti_server_config_database_default }}"
    encoding: utf8mb4
    collation: utf8mb4_unicode_ci

- name: ensure grants
  mysql_user:
    name: "{{ cacti_server_config_database_username }}"
    password: "{{ cacti_server_config_database_password }}"
    priv: "{{ cacti_server_config_database_default }}.*:ALL/mysql.time_zone_name:SELECT"

- name: memory_limit
  lineinfile:
    path: "/etc/php/7.1/{{ item }}/php.ini"
    regexp: '^memory_limit = .*'
    line: 'memory_limit = 512M'
  register: _memory_limit
  with_items:
    - apache2

- name: max_execution_time
  lineinfile:
    path: "/etc/php/7.1/{{ item }}/php.ini"
    regexp: '^max_execution_time = .*'
    line: 'max_execution_time = 60'
  register: _max_execution_time
  with_items:
    - apache2

- name: timezone
  lineinfile:
    path: "/etc/php/7.1/{{ item }}/php.ini"
    line: 'date.timezone = Europe/Amsterdam'
    insertafter: '^;date.timezone.*'
  notify: reload apache2
  with_items:
    - apache2
    - cli

- name: encoding
  lineinfile:
    path: /etc/mysql/percona-server.conf.d/mysqld.cnf
    line: "{{ item }}"
    insertafter: EOF
  notify: restart mysql
  with_items:
    - character_set_server = utf8mb4
    - collation_server = utf8mb4_unicode_ci
    - skip-character-set-client-handshake
    - init_connect = 'SET collation_connection = utf8mb4_unicode_ci; SET NAMES utf8mb4;'
