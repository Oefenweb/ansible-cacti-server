# test file for cacti-server
---
- hosts: all
  remote_user: vagrant
  become: true
  pre_tasks:
    - name: include vars
      include_vars: main.yml
    - include: pre.yml
  roles:
    - role: ../../
      cacti_server_state: pre
  handlers:
    - include: handlers/main.yml

- hosts: all
  remote_user: vagrant
  become: true
  gather_facts: no
  pre_tasks:
    - name: pre | wait for installation to be finished
      command: >
        mysql -Bse "SELECT `cacti` FROM `{{ cacti_server_config_database_default }}`.`version` WHERE `cacti` = '{{ cacti_server_version }}' LIMIT 1;"
      register: _installation_finished
      until: (_installation_finished.stdout_lines | default([]) | length) > 0
      retries: 300
      delay: 1
      changed_when: false
  roles:
    - role: ../../

- hosts: all
  remote_user: vagrant
  become: true
  roles:
    - role: ../../
      cacti_server_state: post
